#!/usr/bin/env python

from sys import argv
import os.path
import subprocess
import click

from q2d2 import markdown_templates

@click.group()
def cli():
    pass

def _prep_files(analysis_root, output_fn, remove_existing=False):
    os.makedirs(analysis_root, exist_ok=True)
    result = os.path.join(analysis_root, output_fn)

    if os.path.exists(result):
        if remove_existing:
            os.remove(result)
        else:
            print("%s has already been generated. Please remove or specify a "
                  "different analysis directory." % result)
            exit(1)
    return result

@cli.command()
@click.option('--analysis-root', "analysis_root", help="The analysis home directory.")
@click.option('--sequences-filepath', "sequences_filepath", help="Path to the sequences in fasta, "
                                           "fastq, fasta.gz, fastq.gz... "
                                           "Actually... just pass the "
                                           "file, we'll figure out what it is.")
def seqs_to_biom(analysis_root, sequences_filepath):
    os.makedirs(analysis_root, exist_ok=True)
    output_fn = _prep_files(analysis_root, '0.seqs-to-biom.md')
    markdown_s = markdown_templates['seqs-to-biom'](sequences_filepath, "exact", "dummy-command", analysis_root)
    open(output_fn, 'w').write(markdown_s)

@cli.command()
@click.option('--analysis-root', "analysis_root", help="The analysis home directory.")
@click.option('--metadata-filepath', "metadata_filepath",
              help="Path to the sample metadata in tsv.")
@click.option('--color-by', "color_by",
              help="Metadata category to color samples by in PCoA.")
def biom_to_pcoa(analysis_root, color_by, metadata_filepath):
    os.makedirs(analysis_root, exist_ok=True)
    output_fn = _prep_files(analysis_root, '1.biom-to-pcoa.md')
    markdown_s = markdown_templates['biom-to-pcoa'](metadata_filepath, color_by, "dummy-command", analysis_root)
    open(output_fn, 'w').write(markdown_s)

@cli.command()
@click.option('--analysis-root', "analysis_root", help="The analysis home directory.")
def start_server(analysis_root):
    markdown_s = markdown_templates['index'](analysis_root)
    output_fn = _prep_files(analysis_root, 'index.md', remove_existing=True)
    open(output_fn, 'w').write(markdown_s)
    command = ' '.join(['ipython', 'notebook', os.path.join(analysis_root, 'index.md')])
    print("", "Run the following to start the Jupyter analysis environment:", command, "", sep='\n')

if __name__ == "__main__":
    cli()
